FROM mcr.microsoft.com/dotnet/core/sdk:3.0-alpine AS build
WORKDIR /app
ARG project_name
# Copy csproj and restore as distinct layers
COPY ./nuget.config /*.props /*.targets ./

# Copy the main source project files
# COPY /*/*.csproj ./
COPY $project_name/*.csproj ./
RUN ls
COPY AppHub/AppHub.csproj /AppHub/

# RUN for file in $(ls *.csproj); do mkdir -p ./${file%.*}/ && mv $file ./${file%.*}/; done
# COPY *.config ./
RUN ls

RUN dotnet restore
COPY ./$project_name/ ./$project_name
COPY ./AppHub ./AppHub

RUN dotnet build .\$project_name\$project_name.csproj -c Release

# Copy everything else and build
# COPY . .

RUN dotnet publish "./${project_name}/${project_name}.csproj" -c Release -o out --no-restore

# COPY . ./
# RUN dotnet ef migrations add InitialCreate

# COPY . ./
# RUN dotnet ef database update

# Build runtime image
FROM microsoft/dotnet:aspnetcore-runtime
WORKDIR /app/

ARG project_name
COPY --from=build /app/$project_name/out .

# https://stackoverflow.com/questions/37904682/how-do-i-use-docker-environment-variable-in-entrypoint-array
ENTRYPOINT dotnet "${HUB_NAME}.dll"
